<script>
const TOKEN = "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";
const OWNER = "ddasports";
const REPO  = "ddasports-app-adm-printvisitor-DSC17_V63265364662";
const PAGES_BASE_URL = "https://ddasports.github.io/ddasports-app-adm-printvisitor-DSC17_V63265364662";

async function submitForm(e) {
  e.preventDefault();

  let name = document.getElementById("name").value.toUpperCase();
  const datetime = new Date().toLocaleString();

  document.getElementById("status").innerText = "â³ Triggering workflow...";

  await fetch(
    `https://api.github.com/repos/${OWNER}/${REPO}/dispatches`,
    {
      method: "POST",
      headers: {
        "Accept": "application/vnd.github+json",
        "Authorization": `Bearer ${TOKEN}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        event_type: "web_trigger",
        client_payload: { name, datetime }
      })
    }
  );

  document.getElementById("status").innerText = "âš™ï¸ Generating receipt...";
  pollWorkflow(name);
}

function pollWorkflow(name) {
  const interval = setInterval(async () => {
    const res = await fetch(
      `https://api.github.com/repos/${OWNER}/${REPO}/actions/runs?per_page=5`,
      {
        headers: {
          "Authorization": `Bearer ${TOKEN}`
        }
      }
    );

    const data = await res.json();
    const run = data.workflow_runs.find(r => r.event === "repository_dispatch");

    if (run && run.status === "completed") {
      clearInterval(interval);

      const link = `${PAGES_BASE_URL}/${name}.html`;

      document.getElementById("status").innerHTML = `
        âœ… Receipt generated! <br><br>
        ðŸ‘‰ <a href="${link}" target="_blank">${name}.html</a>
      `;
    }
  }, 5000);
}
</script>
