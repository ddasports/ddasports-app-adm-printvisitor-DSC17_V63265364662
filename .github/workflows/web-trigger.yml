name: Custom Receipt

on:
  repository_dispatch:
    types: [web_trigger]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-html:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate receipt HTML
        run: |
          # Dates
          DATE_READABLE=$(date +"%d %b %Y")
          CURRENT_TIME=$(TZ="Asia/Kolkata" date +"%I:%M %p")

          # Name from payload (already uppercase from frontend, but double-safety)
          RAW_NAME="${{ github.event.client_payload.name }}"
          NAME=$(echo "$RAW_NAME" | tr '[:lower:]' '[:upper:]')

          FILE_NAME="${NAME}.html"

          echo "Creating receipt: $FILE_NAME"

          DATE_URL_ENCODED=$(date +"%d%%20%b%%20%Y")

          # Create file from template
          cp place_holder.html "$FILE_NAME"

          # Replace placeholders
          sed -i "s/DATE_PLACEHOLDER_SPACE/$DATE_URL_ENCODED/g" "$FILE_NAME"
          sed -i "s/DATE_PLACEHOLDER/$DATE_READABLE/g" "$FILE_NAME"
          sed -i "s/TIME/$CURRENT_TIME/g" "$FILE_NAME"
          sed -i "s/NAME/$NAME/g" "$FILE_NAME"

      - name: Commit generated receipt
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          git add *.html
          git commit -m "chore: generate receipt for $NAME" || exit 0
          git push
